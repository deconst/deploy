*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Always permit established connections
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Permit everything on localhost
-A INPUT -i lo -j ACCEPT

# Allow SSH access from specific hosts
{% for addr in source_addresses %}
-A INPUT -i eth0 -p tcp -m tcp --source {{ addr }} --dport 22 -j ACCEPT
{% endfor %}

# etcd peering
-A INPUT -i eth1 -p tcp -m tcp --dport 2380 -j ACCEPT

# Allow access to service ports in each pod from the load balancer
{% for podnum in range(1, pod_count + 1) %}
# Pod {{ podnum }}:
# Content Service
-A INPUT -i eth1 -p tcp -m tcp --source {{ hostvars.localhost.clb_content_service.balancer.sourceAddresses.ipv4Servicenet }} --dport {{ 8990 + 10 * podnum|int }} -j ACCEPT
# Webhook Service
-A INPUT -i eth1 -p tcp -m tcp --source {{ hostvars.localhost.clb_webhook_service.balancer.sourceAddresses.ipv4Servicenet }} --dport {{ 8993 + 10 * podnum|int }} -j ACCEPT
# Presenter
-A INPUT -i eth1 -p tcp -m tcp --source {{ hostvars.localhost.clb_presenter.balancer.sourceAddresses.ipv4Servicenet }} --dport {{ 79 + podnum|int }} -j ACCEPT

{% endfor %}

COMMIT
