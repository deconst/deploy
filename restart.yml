---
# Coordinate an orderly restart of the cluster if necessary.
#
# The variables in the "when:" clause are populated by the tasks in the worker role. This task
# has been split out from the main role so that it can be performed serially.

- hosts: deconst-worker
  vars_files:
  - vars.yml
  - credentials.yml
  serial: 1
  tasks:

  - name: restart services
    service: name={{ item[1] }}@{{ item[0] }}.service state=restarted
    with_nested:
    - pod_names
    - worker_services
    when: (environment|changed or worker_pulls|changed or worker_units|changed) and not (worker_service_results|changed)
    sudo: yes
    tags: restart
