#!/bin/bash

# Interlock is run a bash script because volumes_from swarm-data:ro doesn't work with swarm/compose
# https://github.com/docker/compose/issues/3077

set -ueo pipefail

PROJECT=$1

ROOT=$(cd $(dirname $0)/.. && pwd)

source ${ROOT}/script/include/util.sh

declare -a SERVICES=(content presenter)

for SERVICE in "${SERVICES[@]}" ; do
  echo "Build image interlock_${SERVICE}"

  docker build \
    --tag interlock_${SERVICE} \
    interlock

  if ! network_exists ${PROJECT}_${SERVICE} ; then
    echo "Create network ${PROJECT}_${SERVICE}"
    docker network create ${PROJECT}_${SERVICE}
  fi

  if ! container_exists ${SERVICE}_interlock ; then
    echo "Run container ${SERVICE}_interlock"
    docker run --detach \
      --name ${SERVICE}_interlock \
      --net ${SERVICE} \
      --label interlock.ext.service.name=${SERVICE} \
      --restart unless-stopped \
      --volumes-from swarm-data:ro \
      interlock_${SERVICE} \
      -D run --config /etc/interlock/config.toml
  fi
done
